<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âquilibra‚ÄëMaths ‚Äî Drag & Drop (fix boutons)</title>
  <style>
    :root{--bg:#f5f9ff;--card:#fff;--accent:#3b82f6;--danger:#ef4444;--text:#0b2540}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center}
    header{width:100%;padding:12px 16px;background:linear-gradient(90deg,var(--accent),#6fb3ff);color:white;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1rem}
    .container{width:100%;max-width:980px;padding:16px}
    .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .center{text-align:center}
    .equation{font-size:1.8rem;font-weight:700;margin:8px 0}
    #balanceWrap{display:flex;justify-content:center;margin:8px 0}
    svg#balance{width:320px;height:160px}
    .actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:8px 0}
    .opTile{background:#e6f0ff;border-radius:12px;padding:10px 14px;font-weight:700;border:2px solid transparent;cursor:grab;user-select:none}
    .opTile:active{cursor:grabbing}
    .opTile.selected{box-shadow:0 6px 20px rgba(59,130,246,0.18);border-color:rgba(59,130,246,0.35)}
    .answerRow{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:12px}
    input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #ddd;width:120px;text-align:center}
    button.btn{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .feedback{min-height:48px;text-align:center;margin-top:10px}
    .progressRow{display:flex;gap:8px;justify-content:center;margin:8px}
    .star{font-size:1.6rem;color:#ddd}
    .star.active{color:gold}

    /* full-screen encouragement overlay */
    .overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(3,7,18,0.7);display:flex;align-items:center;justify-content:center;z-index:999;opacity:0;pointer-events:none;transition:opacity .25s}
    .overlay.show{opacity:1;pointer-events:auto}
    .overlay .card{max-width:760px;text-align:center;transform:translateY(-10px);animation:pop .35s ease forwards}
    @keyframes pop{from{transform:translateY(10px) scale(.98);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}

    .floatClone{position:fixed;z-index:1000;pointer-events:none;transform:translate(-50%,-50%);opacity:.95}

    @media(max-width:520px){ svg#balance{width:260px;height:130px} }
  </style>
</head>
<body>
  <header>
    <h1>√âquilibra‚ÄëMaths ‚öñÔ∏è ‚Äî Drag & Drop</h1>
    <div style="font-size:.9rem;color:rgba(255,255,255,0.9)">Tutoriel ‚Üí niveaux ‚Üí d√©fi</div>
  </header>

  <main class="container">
    <section id="home" class="card center">
      <h2>Bienvenue ‚Äî Commence par le tutoriel</h2>
      <p>Tu vas d'abord r√©soudre 3 √©quations simples en utilisant le glisser‚Äëd√©poser (ou toucher).</p>
      <div style="margin-top:12px"><button id="startBtn" class="btn" type="button" onclick="startApp()">D√©marrer le tutoriel</button></div>
    </section>

    <section id="play" class="card center" style="display:none">
      <div class="progressRow" id="progressRow"></div>
      <div class="equation" id="equationText">x + 3 = 7</div>

      <div id="balanceWrap">
        <svg id="balance" viewBox="0 0 320 160" aria-hidden="true">
          <line x1="20" y1="80" x2="300" y2="80" stroke="#444" stroke-width="3"/>
          <rect id="leftPan" x="60" y="80" width="60" height="22" rx="8" fill="#e6f0ff"/>
          <rect id="rightPan" x="200" y="80" width="60" height="22" rx="8" fill="#feecec"/>
          <g id="leftBubbles" transform="translate(40,20)"></g>
          <g id="rightBubbles" transform="translate(180,20)"></g>
        </svg>
      </div>

      <div class="actions" id="opsRow" aria-label="Op√©rations">
      </div>

      <div class="answerRow">
        <label for="answerInput">x =</label>
        <input id="answerInput" type="text" placeholder="ex: 4" inputmode="numeric">
        <button id="checkBtn" class="btn" type="button" onclick="checkAnswer()">V√©rifier</button>
      </div>

      <div class="feedback" id="feedback"></div>

      <div style="margin-top:10px;font-size:.9rem;color:#666">Drag & drop: fais glisser une op√©ration sur la balance pour l'appliquer aux deux c√¥t√©s. Sur mobile, appuie pour s√©lectionner puis tape la balance.</div>
    </section>
  </main>

  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="card">
      <h1 id="overlayTitle">Bravo ! üéâ</h1>
      <p id="overlayMsg" style="font-size:1.1rem;margin:8px 0">Tu as trouv√© la bonne r√©ponse.</p>
      <div id="overlayDetails" style="margin:8px 0;color:#333"></div>
      <div style="margin-top:12px"><button id="nextBtn" class="btn" type="button" onclick="onNextClicked()">Suivant</button></div>
    </div>
  </div>

  <script>
    // quick defensive wrapper so buttons still work even if some listeners fail
    function startApp(){ try{ _startApp(); }catch(e){ console.error(e); alert('Erreur d√©marrage: '+e.message); } }
    function checkAnswer(){ try{ _checkAnswer(); }catch(e){ console.error(e); alert('Erreur verification: '+e.message); } }
    function onNextClicked(){ try{ _onNextClicked(); }catch(e){ console.error(e); alert('Erreur suivant: '+e.message); } }

    // MAIN
    const STATE = { tutorialMode:true, tutorialRemaining:3, world:1, levelIndex:0, worlds:[{id:1,levels:3},{id:2,levels:4},{id:3,levels:4},{id:4,levels:4},{id:5,levels:5}], current:null, progress:{} };
    const OPS = ['-1','-2','-3','-5','+1','+2','+5','√∑2','√∑3','√∑4','√ó2','√ó3'];
    let floatClone = null, touchDragging=null;

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function choose(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function generateSimpleEquation(){ const a=rand(1,5); const x=rand(1,6); const b=x+a; return {type:'x+a', a:a, b:b, solution:x, text:`x + ${a} = ${b}`}; }
    function generateLevel(world,index){ if(world===1) return generateSimpleEquation(); if(world===2){ const k=choose([2,3,4]); const x=rand(1,6); const b=k*x; return {type:'kx',k:k,b:b,solution:x,text:`${k}x = ${b}`}; } if(world===3){ const k=choose([2,3]); const x=rand(1,6); const a=rand(0,6); const b=k*x+a; return {type:'kx+a',k:k,a:a,b:b,solution:x,text:`${k}x + ${a} = ${b}`}; } if(world===4){ const k=choose([2,3,4]); const x=rand(1,6); const a=rand(0,4); const b=k*(x+a); return {type:'k(x+a)',k:k,a:a,b:b,solution:x,text:`${k}(x + ${a}) = ${b}`}; } if(world===5){ const k=choose([2,3]); const x=rand(1,8); const a=rand(1,6); const b=k*x + a; const word = `Le ${k===2?'double':'triple'} d'un nombre augment√© de ${a} vaut ${b}.`; return {type:'word',k:k,a:a,b:b,solution:x,text:`${k}x + ${a} = ${b}`,wordProblem:word}; } return generateSimpleEquation(); }

    function renderOps(){ const opsRow=document.getElementById('opsRow'); opsRow.innerHTML=''; OPS.forEach(op=>{ const el=document.createElement('div'); el.className='opTile'; el.textContent=op; el.draggable=true; el.setAttribute('data-op',op);
        el.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain',op); setTimeout(()=>el.classList.add('ghost'),0); }); el.addEventListener('dragend',()=>el.classList.remove('ghost'));
        el.addEventListener('click',(e)=>{ if(isTouchDevice()){ document.querySelectorAll('.opTile').forEach(t=>t.classList.remove('selected')); el.classList.add('selected'); document.getElementById('feedback').textContent='Op√©ration s√©lectionn√©e: '+op+'. Tape la balance pour appliquer.'; } else { applyAction(op); } });
        el.addEventListener('touchstart',touchStartHandler);
        opsRow.appendChild(el);
    }); }

    function isTouchDevice(){ return ('ontouchstart' in window) || navigator.maxTouchPoints>0; }

    const balanceSVG = document.getElementById('balance'); balanceSVG.addEventListener('dragover',(e)=>{ e.preventDefault(); }); balanceSVG.addEventListener('drop',(e)=>{ e.preventDefault(); const op=e.dataTransfer.getData('text/plain'); if(op) applyAction(op); });
    balanceSVG.addEventListener('click',()=>{ const sel=document.querySelector('.opTile.selected'); if(sel){ applyAction(sel.getAttribute('data-op')); sel.classList.remove('selected'); } });

    function touchStartHandler(e){ const el=e.currentTarget; const op=el.getAttribute('data-op'); touchDragging={op,el}; floatClone=el.cloneNode(true); floatClone.classList.add('floatClone'); document.body.appendChild(floatClone); moveClone(e.touches[0].clientX,e.touches[0].clientY); document.addEventListener('touchmove',touchMove); document.addEventListener('touchend',touchEnd); }
    function touchMove(e){ if(!floatClone) return; moveClone(e.touches[0].clientX,e.touches[0].clientY); }
    function moveClone(x,y){ floatClone.style.left=x+'px'; floatClone.style.top=y+'px'; }
    function touchEnd(e){ if(!touchDragging) return; const touch=e.changedTouches[0]; const elAt=document.elementFromPoint(touch.clientX,touch.clientY); if(elAt && elAt.closest('#balance')) applyAction(touchDragging.op); if(floatClone){ floatClone.remove(); floatClone=null; } touchDragging=null; document.removeEventListener('touchmove',touchMove); document.removeEventListener('touchend',touchEnd); }

    function applyAction(op){ try{ const cur=STATE.current; if(!cur) return; const fb=document.getElementById('feedback'); fb.textContent=`Op√©ration : ${op} appliqu√©e.`; if(op.includes('+')||op.includes('-')){ const n=parseInt(op.replace('+','')); if(cur.type==='x+a'){ cur.a+=n; cur.b+=n; cur.text=`x + ${cur.a} = ${cur.b}`; } else if(cur.type==='kx+a'){ cur.a+=n; cur.b+=n; cur.text=`${cur.k}x + ${cur.a} = ${cur.b}`; } else if(cur.type==='kx'){ cur.b+=n; cur.text=`${cur.k}x = ${cur.b}`; } else if(cur.type==='k(x+a)'){ cur.b+=n; cur.text=`${cur.k}(x + ${cur.a}) = ${cur.b}`; } else { cur.b+=n; cur.text=`${cur.text.split('=')[0]} = ${cur.b}`; } renderEquation(); animateBubbles(Math.abs(n)); }
      else if(op.includes('√ó')||op.toLowerCase().includes('x')){ const m=parseInt(op.replace(/[√óx]/g,'')); if(cur.type==='x+a'){ cur.a*=m; cur.b*=m; cur.text=`x + ${cur.a} = ${cur.b}`; } else if(cur.type==='kx'){ cur.k*=m; cur.b*=m; cur.text=`${cur.k}x = ${cur.b}`; } else { cur.b*=m; cur.text=`${cur.text.split('=')[0]} = ${cur.b}`; } renderEquation(); animateBubbles(3); }
      else if(op.includes('√∑')){ const d=parseInt(op.replace('√∑','')); const fb=document.getElementById('feedback'); if(cur.type==='x+a'){ if((cur.b % d)===0){ cur.a=cur.a/d; cur.b=cur.b/d; cur.text=`x + ${cur.a} = ${cur.b}`; renderEquation(); animateBubbles(3); } else fb.textContent='Division non enti√®re ‚Äî √©vite pour l\'instant.'; } else if(cur.type==='kx'){ if((cur.k % d)===0 && (cur.b % d)===0){ cur.k=cur.k/d; cur.b=cur.b/d; cur.text=`${cur.k}x = ${cur.b}`; renderEquation(); animateBubbles(3); } else fb.textContent='Division non enti√®re ‚Äî √©vite pour l\'instant.'; } else if(cur.type==='kx+a'){ if((cur.b % d)===0){ cur.k=cur.k/d; cur.a=cur.a/d; cur.b=cur.b/d; cur.text=`${cur.k}x + ${cur.a} = ${cur.b}`; renderEquation(); animateBubbles(3); } else fb.textContent='Division non enti√®re ‚Äî √©vite pour l\'instant.'; } else fb.textContent='Impossible de diviser ici.'; }
      document.getElementById('answerInput').value='';
    } catch(e){ console.error('applyAction error',e); }
    }

    function renderEquation(){ if(!STATE.current) return; const eq=document.getElementById('equationText'); eq.textContent = STATE.current.wordProblem? STATE.current.wordProblem + ' ‚Üí ' + STATE.current.text : STATE.current.text; }
    function animateBubbles(n){ const leftG=document.getElementById('leftBubbles'); const rightG=document.getElementById('rightBubbles'); leftG.innerHTML=''; rightG.innerHTML=''; for(let i=0;i<Math.min(n,8);i++){ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',10+i*10); c.setAttribute('cy',10); c.setAttribute('r',6); c.setAttribute('fill','#60a5fa'); leftG.appendChild(c); const c2=document.createElementNS('http://www.w3.org/2000/svg','circle'); c2.setAttribute('cx',10+i*10); c2.setAttribute('cy',10); c2.setAttribute('r',6); c2.setAttribute('fill','#f87171'); rightG.appendChild(c2); } setTimeout(()=>{ document.getElementById('leftBubbles').innerHTML=''; document.getElementById('rightBubbles').innerHTML=''; },700); }

    function _checkAnswer(){ const cur=STATE.current; if(!cur) return; const ansRaw=document.getElementById('answerInput').value.trim(); const fb=document.getElementById('feedback'); if(!ansRaw){ fb.textContent='Entre une valeur pour x.'; return; } const parsed=parseFloat(ansRaw); if(isNaN(parsed)){ fb.textContent='Format invalide.'; return; } if(Math.abs(parsed - cur.solution) < 1e-9){ showOverlay('Bravo ! üéâ', `x = ${cur.solution} est correct.`, buildVerification(cur, cur.solution)); } else { fb.textContent=`Ce n'est pas correct ‚Äî tu as propos√© ${ansRaw}. Essaie encore.`; } }

    function buildVerification(cur,val){ if(cur.type==='x+a'){ return `${val} + ${cur.a} = ${val + cur.a} ‚Üí ${val + cur.a} = ${cur.b}`; } if(cur.type==='kx'){ return `${cur.k}√ó${val} = ${cur.k*val} ‚Üí ${cur.k*val} = ${cur.b}`; } if(cur.type==='kx+a'){ return `${cur.k}√ó${val} + ${cur.a} = ${cur.k*val + cur.a} ‚Üí ${cur.k*val + cur.a} = ${cur.b}`; } if(cur.type==='k(x+a)'){ return `${cur.k}√ó(${val} + ${cur.a}) = ${cur.k*(val + cur.a)} ‚Üí ${cur.k*(val + cur.a)} = ${cur.b}`; } if(cur.wordProblem){ return `${cur.wordProblem}<br>${cur.text}<br>${buildVerification({type:'kx+a',k:cur.k,a:cur.a,b:cur.b},val)}`; } return ''; }

    function showOverlay(title,msg,details){ document.getElementById('overlayTitle').textContent=title; document.getElementById('overlayMsg').textContent=msg; document.getElementById('overlayDetails').innerHTML=details; document.getElementById('overlay').classList.add('show'); document.getElementById('overlay').setAttribute('aria-hidden','false'); }
    function hideOverlay(){ document.getElementById('overlay').classList.remove('show'); document.getElementById('overlay').setAttribute('aria-hidden','true'); }

    function _onNextClicked(){ hideOverlay(); if(STATE.tutorialMode){ STATE.tutorialRemaining--; if(STATE.tutorialRemaining>0){ loadTutorialLevel(); return; } STATE.tutorialMode=false; STATE.world=1; STATE.levelIndex=0; prepareProgressUI(); loadNextLevel(); return; } STATE.levelIndex++; const worldDef=STATE.worlds.find(w=>w.id===STATE.world); if(STATE.levelIndex >= worldDef.levels){ STATE.progress['w'+STATE.world]=true; STATE.world++; STATE.levelIndex=0; if(STATE.world>STATE.worlds.length){ showOverlay('F√©licitations !','Tu as fini tous les mondes üéñÔ∏è','Tu peux rejouer ou r√©initialiser le jeu.'); return; } }
      loadNextLevel(); updateProgressStars(); }

    function loadTutorialLevel(){ document.getElementById('play').style.display='block'; document.getElementById('home').style.display='none'; STATE.current=generateSimpleEquation(); renderEquation(); document.getElementById('feedback').textContent='Tutoriel ‚Äî r√©sous cette √©quation.'; document.getElementById('answerInput').value=''; }
    function loadNextLevel(){ document.getElementById('play').style.display='block'; document.getElementById('home').style.display='none'; STATE.current=generateLevel(STATE.world,STATE.levelIndex); renderEquation(); document.getElementById('feedback').textContent='Niveau'; document.getElementById('answerInput').value=''; }

    function prepareProgressUI(){ const progressRow=document.getElementById('progressRow'); progressRow.innerHTML=''; STATE.worlds.forEach(w=>{ const sp=document.createElement('div'); sp.className='star'; sp.id='prog_w'+w.id; sp.textContent='‚òÜ'; progressRow.appendChild(sp); }); updateProgressStars(); }
    function updateProgressStars(){ STATE.worlds.forEach(w=>{ const el=document.getElementById('prog_w'+w.id); if(el){ el.textContent = STATE.progress['w'+w.id] ? '‚òÖ' : (STATE.world> w.id ? '‚òÖ' : '‚òÜ'); el.className = 'star ' + (STATE.progress['w'+w.id] ? 'active' : ''); } }); }

    function startUp(){ try{ renderOps(); prepareProgressUI(); }catch(e){ console.error('startup error',e); } }

    // touch helpers already set on ops creation
    function startAppInternal(){ document.getElementById('startBtn').disabled=true; renderOps(); loadTutorialLevel(); prepareProgressUI(); }

    // wire public wrappers to safe internals
    function _startApp(){ startAppInternal(); }

    // initial
    (function init(){ startUp(); if(isTouchDevice()) document.body.classList.add('touch'); console.log('√âquilibra initialis√©'); })();

  </script>
</body>
</html>
